name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Make Maven wrapper executable
        run: chmod +x ./mvnw

      - name: Build with Maven (Linux/macOS)
        run: ./mvnw -B -V -e clean verify

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven (Windows)
        run: .\mvnw.cmd -B -V -e clean verify
        shell: pwsh
  build-and-push-docker:
    # This job will only run on pushes to the main branch
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    # It runs after the 'build' job is successful
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: List files in the repository
        run: ls -la

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
  deploy-to-ec2:
    # This job runs only after 'build-and-push-docker' is successful
    needs: build-and-push-docker
    # It also only runs on a push to the main branch
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        # This action simplifies the SSH process
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Log in to Docker Hub (needed to pull images)
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            
            # Define container and image names for clarity
            CONTAINER_NAME=${{ github.event.repository.name }}
            IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
            
            # Pull the new image
            # docker pull $IMAGE_NAME
            
            # Stop the currently running container (if it exists)
            # '|| true' ensures the workflow doesn't fail if the container isn't running
            docker stop $CONTAINER_NAME || true
            
            # Remove the old container (if it exists)
            docker rm $CONTAINER_NAME || true
            
            # Run the new container
            # --- IMPORTANT! ---
            # You MUST change '-p 8080:8080' to match your application's port.
            # I used 8080 since it's common for Spring Boot projects.
            docker run -d --name $CONTAINER_NAME -p 8080:8080 $IMAGE_NAME
            
            # (Optional) Clean up old, dangling Docker images to save space
            docker image prune -f

            